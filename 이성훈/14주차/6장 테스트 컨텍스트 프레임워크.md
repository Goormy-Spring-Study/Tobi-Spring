# 6장

## 테스트 컨텍스트 프레임워크

스프링은 테스트에 사용되는 애플리케이션 컨텍스트를 생성하고 관리하고 테스트에 적용해주는 기능을 가진 테스트 프레임워크를 제공한다. 이를 **테스트 컨텍스트 프레임워크**라고 한다.

### 테스트용 애플리케이션 컨텍스트 캐싱과 설정파일

JUnit 4에서는 @Test라는 애노테이션만 붙여주면 메소드가 속한 클래스는 테스트 클래스가 되며, 각각 하나의 독립적인 테스트가 된다. JUnit은 테스트 메소드를 실행할 때마다 매번 테스트 클래스의 새로운 오브젝트를 만든다.

문제는 **테스트가 독립적이라고 해서 매번 스프링 컨텍스트(컨테이너)를 새로 만드는건 매우 비효율적**이라는 점이다.

그래서 스프링은 테스트가 사용하는 컨텍스트를 캐싱해서 여러 테스트에서 하나의 컨텍스트를 공유할 수 있는 방법을 제공한다.

```java
@RunWith(SpringJUnit4ClassRunner.class) // Spring 3.1 기준
@ContextConfiguration("/test-applicationContext")
public class Test1 {
	@Test public void testMethod1() { ... }
	...
}
```

스프링 테스트 컨텍스트 캐싱이 제대로 동작하는지 확인하려면, 테스트 로그에서 아래와 같은 내용을 확인하면 된다.

- **캐싱된 컨텍스트 재사용**
    
    ```
    Reusing cached context for class TestA.
    ```
    
    로그에 이 메시지가 출력되면 컨텍스트 캐싱이 정상적으로 작동 중임을 의미한다.
    
- **새로운 컨텍스트 생성**
    
    ```
    Creating ApplicationContext for class TestB.
    ```
    
    이 메시지가 반복적으로 나타난다면 캐싱이 제대로 동작하지 않고 있음을 의미한다.
    

### 공유 컨텍스트 사용 시 주의할 점

캐싱 기법을 통해 하나의 컨텍스트를 여러 테스트가 공유할 수 있다는 건 분명 테스트 컨텍스트 프레임워크의 장점이다. 

**하지만, 자신이 독점하는 것이 아니므로 그 구성이나 내부 정보를 함부로 변경해서는 안 된다.** 

### 트랜잭션 지원 테스트 작성 방법

**@Transactional**

스프링의 AOP 적용 대상은 컨텍스트에 등록된 빈 오브젝트뿐이다. 이 말대로라면 JUnit 프레임워크가 제어권을 가지는 테스트 클래스의 오브젝트는 AOP의 적용 대상이 될 수 없다.

하지만 스프링의 테스트 컨텍스트 프레임워크는 마치 AOP를 적용한 것과 유사한 방식으로 트랜잭션 기능을 테스트 메소드에 적용할 수 있게 해준다. (@Transaction)

### 주의 사항

테스트의 트랜잭션의 롤백 default는 rollback=true 라는 점, 그럼에도 불구하고 DB에 롤백이 반영되거나 반영되지 말아야 하는 부분에 대해서 주의해야한다.

또한, ORM의 경우, 적절한 순간에 플러쉬(flush()) 를 통해 DB에 반영해야 한다는 점도 기억해야 한다.