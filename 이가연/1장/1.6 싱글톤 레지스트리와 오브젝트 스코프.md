# 1.6 싱글톤 레지스트리와 오브젝트 스코프

# 빈의 동일성

동일성과 동등성은 다른 개념이다. 

`동등성` : 메소드의 결과값이 같은 경우 

`동일성` : 같은 주소를 가진 객체의 경우 동일하다고 말한다. 

생성자로 매번 생성한 인스턴스인 UserDao는 동일하지 않지만, ApplicationContext에서 .getBean()으로 가져온 UserDao는 동일하다. 이를 통해 스프링은 빈을 요청했을 때 매번 동일한 오브젝트를 돌려준다는 것을 알 수 있다. 

# 싱글톤 레지스트리로서의 애플리케이션 컨텍스트

## 싱글톤 레지스트리란?

스프링 컨테이너가 빈을 싱글톤으로 생성하고 관리하는 방식을 뜻한다. 단, 일반적인 싱글톤 디자인 패턴에서 **단점을 개선한 다른 방법**으로 구현된다. 

## 싱글톤 방식을 사용하는 이유

만약 요청 1개에 5개의 오브젝트가 관여한다 할 때 싱글톤을 사용하지 않는다면 1000명의 사용자가 동시에 요청을 했을 때 5000개의 오브젝트를 생성하고 제거해야 한다. 이러한 오브젝트 생성과 제거에 드는 오버헤드 비용은 상당하다. 이러한 오버헤드 문제를 해결하기 위해 **1개의 오브젝트만 만들어 사용하는 것을 `싱글톤 패턴`** 이라 하며 서버 환경에서는 싱글톤의 사용이 권장된다. 스프링이 싱글톤 패턴을 사용하는 이유도 서버환경인데서 이유를 찾을 수 있다. 

서블릿도 이러한 싱글톤 개념을 적용한 대표적인 예인데, 서블릿 클래스당 하나의 오브젝트만 만들어두고 여러 스레드가 이 하나의 오브젝트를 공유하며 동시에 사용한다. 

## 싱글톤 패턴의 한계

싱글톤은 까다롭고 단점도 많다. 

자바에서 싱글톤을 구현하는 방법은 다음과 같다. 

1. 생성자를 `private`으로 만들어서 다른 곳에서 생성되는 것을 방지한다. 
2. 생성된 싱글톤 오브젝트를 저장할 수 있는 동일 타입의 `static` 필드를 정의한다. 
3. static factory 메소드인 `.getInstance()` 를 만들고 이 메소드가 최초로 호출되는 시점 단 한 번만 오브젝트가 만들어지게 한다. (또는 초기값으로 미리 인스턴스를 생성한다.) 생성된 오브젝트는 static 필드에 저장한다. 
4. 인스턴스 생성 후 오브젝트는 .getInstance 를 통해서만 접근 가능하다.

```java
public class UserDaoSingleton {
    private static UserDaoSingleton INSTANCE;
    
    private UserDaoSingleton() {
    }
    
    public static synchronized UserDaoSingleton getInstance() {
        if(INSTANCE == null) INSTANCE = new UserDaoSingleton();
        return INSTANCE;
    }
}
```

이러한 고전 방식의 싱글톤 패턴은 다음과 같은 문제점을 가진다. 

- private 생성자로 인해 상속이 불가능하다.
    - private 생성자를 가진 클래스는 다른 생성자가 없다면 상속이 불가능하다. (객체지향의 장점인 다형성 활용 불가능)
- 싱글톤은 테스트하기 힘들다.
    - 인스턴스 생성 방식이 제한적이어서 목 객체 등으로 활용하기 힘들다.
    - 필요한 오브젝트를 다이나믹하게 주입해줄 수 없다.
- 서버 환경에서는 싱글톤이 하나만 만들어지는 것을 보장할 수 없다.
    - 클래스 로더 구성에 따라 싱글톤임에도 오브젝트가 하나 이상 만들어질 수 있다.
    - 여러 개의 JVM에 분산되는 경우도 독립적으로 오브젝트가 생성되기 때문에 싱글톤으로서의 가치가 떨어진다.
- 전역 상태를 만들 수 있다.
    - 자유롭게 접근하고 수정하고 공유할 수 있는 전역 상태를 갖는 것은 바람직하지 않은 프로그래밍이다.

→ 따라서 Java의 싱글톤 패턴 기법은 싱글톤이 보장되지 않으며 객체지향 특징도 활용할 수 없다. 

# 싱글톤 레지스트리

싱글톤 서비스 오브젝트를 사용해야 하는 건 맞는데 단점이 너무 많다. 

스프링은 이러한 단점을 개선한 `싱글톤 레지스트리`를 사용해 오브젝트를 관리한다. 

스프링 컨테이너는 싱글톤을 생성하고 관리하고 공급하는 싱글톤 관리 컨테이너인 것이다. 

싱글톤 레지스트리의 특징은 다음과 같다. 

## 평범한 자바 클래스를 싱글톤으로 활용할 수 있다.

IOC 컨테이너(스프링 컨테이너)에게 생성, 관계설정, 사용 등 제어권을 넘기면 평범한 자바 클래스도 싱글톤 방식으로 만들어져 관리할 수 있다. 오브젝트 생성 권한이 모두 컨테이너에게 있기 때문이다. 

→ **스프링 컨테이너를 통해 static 메소드, private 생성자 등을 사용하지 않아도 된다.** 

## 테스트에서도 싱글톤 클래스를 활용할 수 있다.

static, private 등이 빠졌기 때문에 일반적인 클래스처럼 클래스를 싱글톤으로 사용할 수 있다. 

테스트 환경에서 오브젝트를 만드는데 자유로워지며, 목 객체 대체와 생성자 주입도 가능해졌다. 

→ **스프링은 IOC 컨테이너일 뿐만 아니라 싱글톤을 객체지향 관점에 맞춰 관리해주는 싱글톤 레지스트리이기도 하다.** 

# 싱글톤 주의점

## 싱글톤은 stateless이어야 한다.

스프링은 멀티 스레드 환경이므로 싱글톤이 사용될 때 오브젝트 내에 상태 정보를 가지고 있어선 안된다. 

단순 읽기 용도면 상관 없지만 공유되는 상태 정보를 가지면 다른 사용자들에 의해 값이 변경될 여지가 있다.

단, **파라미터, 로컬 변수, 리턴 값 등은 자유롭게 이용**할 수 있기 때문에 DB로부터 얻어온 데이터는 이를 이용해 처리하면 된다.

또 자신이 사용하는 다른 싱글톤 빈을 저장하려는 용도라면 인스턴스 변수를 사용해도 무관하다. 

일반적으로 생성자 주입에선 private final을 이용해 빈의 주입 정보를 기억한다. 

```java
@Component
public class StatefulService {
    private int value; // 상태를 저장하는 필드

    public void setValue(int value) {
        this.value = value;
    }

    public int getValue() {
        return value;
    }
}
```

```java
@Component
public class StatelessService {
    public int calculate(int value) {
        return value * 2; // 메소드 내에서만 연산하고, 상태를 변경하지 않음
    }
}
```

# 스프링 빈의 스코프

빈의 스코프란 빈이 생성되고 적용되는 범위를 뜻한다. 

스프링 빈의 **기본 스코프는 싱글톤**이며 스프링 컨테이너가 존재하는 동안 유지된다. 

단 경우에 따라서 싱글톤 외에 다른 스코프를 가질 수 있는데, 대표적인 예시가 프로토타입 스코프다. 프로토타입 스코프는 싱글톤과 달리 컨테이너에 빈을 요청할 때마다 새로운 오브젝트를 생성한다. 또 요청 스코프, 세션 스코프 등도 있다.
